<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Travel Mate - Live Journey</title>
    <style>
        /* Base Styles (Matching trip-planner.html) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            height: 100%; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Match trip-planner background */
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.25) 100%), url(images/backend.jpg);
            background-size: cover; background-position: center center; background-attachment: fixed; background-repeat: no-repeat;
            color: #333;
            overflow-y: auto; 
        }

        /* Header (Matching trip-planner.html) */
        .header { display:flex; justify-content:space-between; align-items:center; width:100%; height:80px; 
            background-color:rgba(255,255,255,0.95);
            backdrop-filter: blur(10px); position: sticky; 
            top: 0;
            padding: 0 20px; 
            box-shadow: 0 2px 20px rgba(0,0,0,0.1); z-index: 200; 
        }
        .left-section { display:flex; align-items:center; gap:20px; }
        .appimg { width:55px; height:55px; border-radius:12px; overflow:hidden; }
        .logo-img { width:100%; height:100%; object-fit:cover; border-radius:12px; }
        .appname { font-size:24px; font-weight:700; color:#2d3748; }
        .back-home { background: rgba(255,255,255,0.9); border:2px solid #e2e8f0; color:#667eea; padding:10px 20px; border-radius:25px; cursor:pointer; 
            font-weight:500; transition:all .3s ease; text-decoration:none; font-size:14px; 
        }
        .back-home:hover { background:white; border-color:#667eea; transform:translateY(-2px); box-shadow: 0 4px 15px rgba(102,126,234,0.2); }

        /* Main Content Grid */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        #main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Map gets 2/3, Sidebar gets 1/3 */
            gap: 20px;
        }

        /* Map and Controls */
        #map-panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        #map {
            width: 100%;
            height: 600px; /* Fixed map height */
            border-radius: 12px;
        }

        /* Route Summary/Places Sidebar */
        #sidebar-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .info-card h3 {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }
        
        .route-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #e2e8f0;
            font-size: 1rem;
        }

        .route-detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #4a5568;
            font-weight: 500;
        }
        .detail-value {
            color: #667eea;
            font-weight: 700;
        }

        /* Places List */
        .place-list-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }
        .place-list-item:hover {
            background: rgba(102, 126, 234, 0.05);
            padding-left: 5px;
            border-radius: 4px;
        }
        .place-list-item h4 {
            font-size: 1.05rem;
            color: #38a169;
            margin-bottom: 4px;
        }
        .place-list-item p {
            font-size: 0.9rem;
            color: #718096;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            #main-grid {
                grid-template-columns: 1fr; /* Stack columns on smaller screens */
            }
            #map {
                height: 450px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="left-section">
            <div class="appimg">
                <img src="images/logo.jpg" alt="AI Travel Mate Logo" class="logo-img">
            </div>
            <div class="appname">AI Travel Mate</div>
        </div>
        <a id="stop-tracking-btn" href="trip-planner.html" class="back-home">‚Üê Stop Tracking & Go Back</a>
    </div>

    <div class="container">
        <div id="main-grid">
            <div id="map-panel">
                <h2 style="color: #38a169; margin-bottom: 15px;">Live Route Tracking</h2>
                <div id="map"></div>
                <p id="tracking-status" style="margin-top: 15px; text-align: center; color: #4a5568;">
                    ‚è≥ Initializing map and location services...
                </p>
            </div>

            <div id="sidebar-panel">
                <div id="route-summary-card" class="info-card">
                    <h3>Route Summary</h3>
                    <div id="summary-details">
                        <p style="color:#e53e3e;">Loading route data...</p>
                    </div>
                </div>

                <div id="places-card" class="info-card">
                    <h3>Key Places Along Route</h3>
                    <div id="places-list">
                        <p style="color:#718096;">Loading nearby places...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let routeData = null; 
        let placesData = [];
        let currentLocationMarker = null;
        let watchId = null;

        // --- CORE MAP INITIALIZATION ---
        function initMap() {
            // 1. Get stored data
            const routeJSON = localStorage.getItem('selectedRouteData');
            const placesJSON = localStorage.getItem('nearbyPlacesData');
            
            if (!routeJSON) {
                alert("No route data found. Please select a route in the trip planner.");
                window.location.href = 'trip-planner.html';
                return;
            }

            try {
                routeData = JSON.parse(routeJSON);
                placesData = JSON.parse(placesJSON) || [];
            } catch (e) {
                console.error("Error parsing route data:", e);
                alert("Error parsing route data. Returning to planner.");
                window.location.href = 'trip-planner.html';
                return;
            }

            // 2. Initialize the Map
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 20.5937, lng: 78.9629 }, 
                zoom: 10,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
            });
            
            // CRITICAL CHECK: Ensure map is initialized before proceeding
            if (!map) {
                document.getElementById('tracking-status').innerHTML = '‚ùå Map failed to load. Check API Key.';
                return;
            }

            // 3. Draw the single route and fit map bounds
            drawRoute();
            
            // 4. Draw the places (markers) and populate sidebar
            drawPlaces();
            
            // 5. Populate Route Summary
            populateRouteSummary();
            
            // 6. Start the user tracking
            startGeolocationTracking();
            
            // 7. Set up the stop tracking button event
            document.getElementById('stop-tracking-btn').addEventListener('click', stopTrackingAndClearData);
        }
        
        function stopTrackingAndClearData() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            localStorage.removeItem('selectedRouteData');
            localStorage.removeItem('nearbyPlacesData');
        }

        // --- DRAWING FUNCTIONS ---

        function drawRoute() {
            if (!map || !routeData || !routeData.overview_polyline) return;

            const decodedPath = google.maps.geometry.encoding.decodePath(routeData.overview_polyline.points);

            const polyline = new google.maps.Polyline({
                path: decodedPath,
                geodesic: true,
                strokeColor: '#38A169', 
                strokeOpacity: 1.0,
                strokeWeight: 6 
            });

            polyline.setMap(map);
            
            const bounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(routeData.bounds.south, routeData.bounds.west),
                new google.maps.LatLng(routeData.bounds.north, routeData.bounds.east)
            );
            map.fitBounds(bounds);

            // Start Marker
            new google.maps.Marker({
                position: decodedPath[0],
                map: map,
                label: 'A',
                title: routeData.legs[0].start_address,
                icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' // Standard start marker
            });

            // End Marker
            new google.maps.Marker({
                position: decodedPath[decodedPath.length - 1],
                map: map,
                label: 'B',
                title: routeData.legs[0].end_address,
                icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' // Standard end marker
            });
        }
        
        function drawPlaces() {
            const placesListElement = document.getElementById('places-list');
            placesListElement.innerHTML = '';
            
            if (placesData.length === 0) {
                placesListElement.innerHTML = '<p style="color:#718096;">No points of interest were saved for this route.</p>';
                return;
            }

            placesData.forEach(place => {
                const marker = new google.maps.Marker({
                    map: map,
                    // Convert stored position object back to LatLng
                    position: new google.maps.LatLng(place.position.lat, place.position.lng),
                    title: place.title,
                    // Recreate the custom icon based on stored properties
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: place.icon.fillColor,
                        fillOpacity: place.icon.fillOpacity || 0.9,
                        scale: place.icon.scale || 6,
                        strokeColor: '#ffffff',
                        strokeWeight: 1
                    }
                });

                const infoWindowContent = `
                    <div style="font-weight:600; font-size:14px;">${place.title}</div>
                    <a href="http://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.title)}" target="_blank" style="font-size:12px; color:#667eea;">View on Google Maps</a>
                `;

                const infoWindow = new google.maps.InfoWindow({ content: infoWindowContent });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                // Create list item for sidebar
                const listItem = document.createElement('div');
                listItem.className = 'place-list-item';
                // Use a more readable category name
                const categoryLabel = place.icon.categoryKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                listItem.innerHTML = `
                    <h4>${place.title}</h4>
                    <p>Category: ${categoryLabel}</p>
                `;
                
                // List Item Click Listener (pan to marker)
                listItem.addEventListener('click', () => {
                    map.panTo(marker.getPosition());
                    map.setZoom(17);
                    infoWindow.open(map, marker);
                });

                placesListElement.appendChild(listItem);
            });
        }
        
        function populateRouteSummary() {
            if (!routeData || !routeData.legs || routeData.legs.length === 0) return;
            
            const leg = routeData.legs[0];
            const summaryDetails = document.getElementById('summary-details');
            
            summaryDetails.innerHTML = `
                <div class="route-detail-item">
                    <span class="detail-label">Start Point:</span>
                    <span class="detail-value">${leg.start_address.split(',')[0]}</span>
                </div>
                <div class="route-detail-item">
                    <span class="detail-label">End Point:</span>
                    <span class="detail-value">${leg.end_address.split(',')[0]}</span>
                </div>
                <div class="route-detail-item">
                    <span class="detail-label">Distance:</span>
                    <span class="detail-value">${leg.distance.text}</span>
                </div>
                <div class="route-detail-item">
                    <span class="detail-label">Est. Time:</span>
                    <span class="detail-value">${leg.duration.text}</span>
                </div>
                <div class="route-detail-item">
                    <span class="detail-label">Places of Interest:</span>
                    <span class="detail-value">${placesData.length}</span>
                </div>
            `;
        }

        // --- GEOLOCATION TRACKING ---

        function startGeolocationTracking() {
            const statusElement = document.getElementById('tracking-status');
            if (!navigator.geolocation) {
                statusElement.innerHTML = '‚ùå Geolocation is not supported by your browser.';
                return;
            }
            
            const updateMap = (position) => {
                const latLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                if (currentLocationMarker === null) {
                    // Create custom marker for current location
                    currentLocationMarker = new google.maps.Marker({
                        map: map,
                        position: latLng,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#2196F3',
                            fillOpacity: 1,
                            scale: 10,
                            strokeColor: '#fff',
                            strokeWeight: 4
                        },
                        title: 'Your Current Location'
                    });
                    // Center and zoom in on initial fix
                    map.setCenter(latLng);
                    map.setZoom(17); 
                } else {
                    currentLocationMarker.setPosition(latLng);
                }
                
                statusElement.innerHTML = `üü¢ Tracking: Lat ${position.coords.latitude.toFixed(4)}, Lng ${position.coords.longitude.toFixed(4)}`;
            };

            const errorHandler = (error) => {
                console.error(`Geolocation error: ${error.code} ${error.message}`);
                statusElement.innerHTML = 'üî¥ Tracking failed. Check location permissions.';
            };

            watchId = navigator.geolocation.watchPosition(updateMap, errorHandler, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }
    </script>

    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCeAcrbFyaVO2bxPxR2srbYyOL3fa9kmJE&callback=initMap&libraries=geometry,places">
    </script>
</body>
</html>